In this lab, we will exploit misconfigured Google Cloud Storage (GCS) bucket policies to gain administrative access to one of the storage buckets. Within this bucket, we will find credentials for a low-privileged virtual machine (VM). We'll then use these credentials to pivot and access higher-privileged compute instances via the low-privileged machine.

---

# Part 01: Exploiting Misconfigured Bucket Policies for Privilege Escalation

In this first part of the lab, we will exploit misconfigured Google Cloud Storage (GCS) bucket policies to gain administrative access to one of the storage buckets.

---

## Walkthrough

### **Step 1: Access the Application**

Open any blog post from the GCPGoat application’s homepage.

![](GCPGoat%20Screenshots/GCPGoat-Lab02/GCPGoat-Lab02-01.png)

---

### **Step 2: Open the Blog Image**

Right-click on the image in the blog post and open it in a new tab.

![](GCPGoat%20Screenshots/GCPGoat-Lab02/GCPGoat-Lab02-02.png)

---

### **Step 3: Identify the Storage Bucket**

In the new tab, observe the image URL. You'll notice it's being served from a Google Cloud Storage bucket.

![](GCPGoat%20Screenshots/GCPGoat-Lab02/GCPGoat-Lab02-03.png)

Extract and note the bucket name appearing after `storage.googleapis.com`.

---

### **Step 4: Attempt to List the Bucket’s Content**

Use the following URL (replacing `<BUCKET NAME>` with the actual bucket name) to try listing its contents:

```
https://storage.googleapis.com/<BUCKET NAME>
```

![](GCPGoat%20Screenshots/GCPGoat-Lab02/GCPGoat-Lab02-04.png)

You’ll likely receive an "Access Denied" error.

---

### **Step 5: Test Bucket Permissions**

Use the following URL to check which permissions you have on the bucket:

```
https://www.googleapis.com/storage/v1/b/BUCKET_NAME/iam/testPermissions?permissions=storage.buckets.delete&permissions=storage.buckets.get&permissions=storage.buckets.getIamPolicy&permissions=storage.buckets.setIamPolicy&permissions=storage.buckets.update&permissions=storage.objects.create&permissions=storage.objects.delete&permissions=storage.objects.get&permissions=storage.objects.list&permissions=storage.objects.update
```

Replace `BUCKET_NAME` with the bucket’s actual name.

![](GCPGoat%20Screenshots/GCPGoat-Lab02/GCPGoat-Lab02-05.png)

In this case, you’ll see that only the `storage.buckets.get` permission is granted. However, the bucket name includes “prod”, which suggests there might also be a development version.

---

### **Step 6: Discover the Dev Bucket**

Try accessing a similar bucket name using `dev` instead of `prod`:

```
https://storage.googleapis.com/<DEV BUCKET NAME>
```

![](GCPGoat%20Screenshots/GCPGoat-Lab02/GCPGoat-Lab02-06.png)

You may again receive an "Access Denied" response—but this confirms the dev bucket exists.

---

### **Step 7: Check Dev Bucket Permissions**

Repeat the permission test on the dev bucket:

```
https://www.googleapis.com/storage/v1/b/BUCKET_NAME/iam/testPermissions?...<permissions list>...
```

![](GCPGoat%20Screenshots/GCPGoat-Lab02/GCPGoat-Lab02-07.png)

This time, you might notice additional permissions:

* `storage.buckets.setIamPolicy`: Allows modifying the bucket’s IAM policy.
* `storage.buckets.getIamPolicy`: Allows reading the bucket’s IAM policy.

---

### **Step 8: Retrieve Current IAM Policy**

Use the `gsutil` command-line tool to fetch the current IAM policy of the bucket:

```
gsutil iam get gs://<BUCKET NAME>
```

![](GCPGoat%20Screenshots/GCPGoat-Lab02/GCPGoat-Lab02-08.png)

Here, you’ll find that the `allUsers` group (anonymous users) already has a custom role with certain permissions.

---

### **Step 9: Add Admin Role to allUsers**

Now that you have IAM modification rights, assign the `admin` role to `allUsers`:

```
gsutil iam ch allUsers:admin gs://<BUCKET NAME>
```

![](GCPGoat%20Screenshots/GCPGoat-Lab02/GCPGoat-Lab02-09.png)

---

### **Step 10: Verify Admin Role Assignment**

Confirm the change by listing the IAM roles again:

```
gsutil iam get gs://<BUCKET NAME>
```

![](GCPGoat%20Screenshots/GCPGoat-Lab02/GCPGoat-Lab02-10.png)

You should now see that `allUsers` have admin access.

---

### **Step 11: Retest Permissions**

Test your updated permissions using the same TestIamPermissions API:

```
https://www.googleapis.com/storage/v1/b/BUCKET_NAME/iam/testPermissions?...<permissions list>...
```

![](GCPGoat%20Screenshots/GCPGoat-Lab02/GCPGoat-Lab02-11.png)

You should now have full access, including the ability to list, update, and delete objects in the bucket.

---

### **Step 12: List Bucket Contents**

Now that you have admin access, try listing the contents again:

```
https://storage.googleapis.com/<DEV BUCKET NAME>
```

![](GCPGoat%20Screenshots/GCPGoat-Lab02/GCPGoat-Lab02-12.png)

The contents will now be listed, confirming successful privilege escalation.

---

